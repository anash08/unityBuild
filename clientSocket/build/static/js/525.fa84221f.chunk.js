"use strict";(self.webpackChunkclient=self.webpackChunkclient||[]).push([[525],{7525:function(e,n,t){t.r(n),t.d(n,{OpenAI:function(){return _},OpenAIChat:function(){return Z},PromptLayerOpenAI:function(){return w},PromptLayerOpenAIChat:function(){return I}});var r=t(1752),i=t(1120),a=t(4165),o=t(3433),l=t(7762),u=t(5861),p=t(1413),s=t(5671),c=t(3144),d=t(2963),v=t(7326),m=t(136),f=t(9388),b=t(1115),y=t(2697),A=t(3399),h=function(e,n){return e.reduce((function(e,t,r){var i=Math.floor(r/n),a=e[i]||[];return e[i]=a.concat([t]),e}),[])},g=t(812),O=t(3834),P=t(7756),Z=function(e){(0,m.Z)(t,e);var n=(0,f.Z)(t);function t(e,r){var i,a,o,l,u,c,d,m,f,b,A,h,g,O,P;if((0,s.Z)(this,t),P=n.call(this,null!==e&&void 0!==e?e:{}),Object.defineProperty((0,v.Z)(P),"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty((0,v.Z)(P),"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty((0,v.Z)(P),"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty((0,v.Z)(P),"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty((0,v.Z)(P),"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty((0,v.Z)(P),"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty((0,v.Z)(P),"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty((0,v.Z)(P),"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty((0,v.Z)(P),"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty((0,v.Z)(P),"prefixMessages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty((0,v.Z)(P),"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty((0,v.Z)(P),"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty((0,v.Z)(P),"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty((0,v.Z)(P),"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty((0,v.Z)(P),"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty((0,v.Z)(P),"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty((0,v.Z)(P),"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty((0,v.Z)(P),"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty((0,v.Z)(P),"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty((0,v.Z)(P),"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty((0,v.Z)(P),"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),P.openAIApiKey=null!==(i=null===e||void 0===e?void 0:e.openAIApiKey)&&void 0!==i?i:(0,y.lS)("OPENAI_API_KEY"),P.azureOpenAIApiKey=null!==(a=null===e||void 0===e?void 0:e.azureOpenAIApiKey)&&void 0!==a?a:(0,y.lS)("AZURE_OPENAI_API_KEY"),!P.azureOpenAIApiKey&&!P.openAIApiKey)throw new Error("(Azure) OpenAI API key not found");if(P.azureOpenAIApiInstanceName=null!==(o=null===e||void 0===e?void 0:e.azureOpenAIApiInstanceName)&&void 0!==o?o:(0,y.lS)("AZURE_OPENAI_API_INSTANCE_NAME"),P.azureOpenAIApiDeploymentName=null!==(l=(null===e||void 0===e?void 0:e.azureOpenAIApiCompletionsDeploymentName)||(null===e||void 0===e?void 0:e.azureOpenAIApiDeploymentName))&&void 0!==l?l:(0,y.lS)("AZURE_OPENAI_API_COMPLETIONS_DEPLOYMENT_NAME")||(0,y.lS)("AZURE_OPENAI_API_DEPLOYMENT_NAME"),P.azureOpenAIApiVersion=null!==(u=null===e||void 0===e?void 0:e.azureOpenAIApiVersion)&&void 0!==u?u:(0,y.lS)("AZURE_OPENAI_API_VERSION"),P.modelName=null!==(c=null===e||void 0===e?void 0:e.modelName)&&void 0!==c?c:P.modelName,P.prefixMessages=null!==(d=null===e||void 0===e?void 0:e.prefixMessages)&&void 0!==d?d:P.prefixMessages,P.modelKwargs=null!==(m=null===e||void 0===e?void 0:e.modelKwargs)&&void 0!==m?m:{},P.timeout=null===e||void 0===e?void 0:e.timeout,P.temperature=null!==(f=null===e||void 0===e?void 0:e.temperature)&&void 0!==f?f:P.temperature,P.topP=null!==(b=null===e||void 0===e?void 0:e.topP)&&void 0!==b?b:P.topP,P.frequencyPenalty=null!==(A=null===e||void 0===e?void 0:e.frequencyPenalty)&&void 0!==A?A:P.frequencyPenalty,P.presencePenalty=null!==(h=null===e||void 0===e?void 0:e.presencePenalty)&&void 0!==h?h:P.presencePenalty,P.n=null!==(g=null===e||void 0===e?void 0:e.n)&&void 0!==g?g:P.n,P.logitBias=null===e||void 0===e?void 0:e.logitBias,P.maxTokens=null===e||void 0===e?void 0:e.maxTokens,P.stop=null===e||void 0===e?void 0:e.stop,P.streaming=null!==(O=null===e||void 0===e?void 0:e.streaming)&&void 0!==O&&O,P.n>1)throw new Error("Cannot use n > 1 in OpenAIChat LLM. Use ChatOpenAI Chat Model instead.");if(P.azureOpenAIApiKey){if(!P.azureOpenAIApiInstanceName)throw new Error("Azure OpenAI API instance name not found");if(!P.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!P.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found")}return P.clientConfig=(0,p.Z)((0,p.Z)({apiKey:P.openAIApiKey},r),null===e||void 0===e?void 0:e.configuration),P}return(0,c.Z)(t,[{key:"callKeys",get:function(){return["stop","signal","timeout","options","promptIndex"]}},{key:"lc_secrets",get:function(){return{openAIApiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY"}}},{key:"lc_aliases",get:function(){return{modelName:"model",openAIApiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}},{key:"invocationParams",value:function(e){var n;return(0,p.Z)({model:this.modelName,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,n:this.n,logit_bias:this.logitBias,max_tokens:-1===this.maxTokens?void 0:this.maxTokens,stop:null!==(n=null===e||void 0===e?void 0:e.stop)&&void 0!==n?n:this.stop,stream:this.streaming},this.modelKwargs)}},{key:"_identifyingParams",value:function(){return(0,p.Z)((0,p.Z)({model_name:this.modelName},this.invocationParams()),this.clientConfig)}},{key:"identifyingParams",value:function(){return(0,p.Z)((0,p.Z)({model_name:this.modelName},this.invocationParams()),this.clientConfig)}},{key:"formatMessages",value:function(e){var n={role:"user",content:e};return this.prefixMessages?[].concat((0,o.Z)(this.prefixMessages),[n]):[n]}},{key:"_call",value:function(){var e=(0,u.Z)((0,a.Z)().mark((function e(n,t,r){var i,o,u,s,c=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(u=this.invocationParams(t)).stream){e.next=7;break}return e.next=4,new Promise((function(e,i){var a,o=!1,s=!1;c.completionWithRetry((0,p.Z)((0,p.Z)({},u),{},{messages:c.formatMessages(n)}),(0,p.Z)((0,p.Z)({signal:t.signal},t.options),{},{adapter:A.Z,responseType:"stream",onmessage:function(n){var u,p;if("[DONE]"===(null===(u=n.data)||void 0===u||null===(p=u.trim)||void 0===p?void 0:p.call(u))){if(s||o)return;s=!0,e(a)}else{var c=JSON.parse(n.data);if(null!==c&&void 0!==c&&c.error){if(o)return;return o=!0,void i(c.error)}var d=c;a||(a={id:d.id,object:d.object,created:d.created,model:d.model,choices:[]});var v,m=(0,l.Z)(d.choices);try{var f=function(){var e=v.value;if(null!=e){var n,i,o,l,u,p,s,c,d,m=a.choices.find((function(n){return n.index===e.index}));if(!m)m={index:e.index,finish_reason:null!==(p=e.finish_reason)&&void 0!==p?p:void 0},a.choices.push(m);if(!m.message)m.message={role:null===(s=e.delta)||void 0===s?void 0:s.role,content:null!==(c=null===(d=e.delta)||void 0===d?void 0:d.content)&&void 0!==c?c:""};m.message.content+=null!==(n=null===(i=e.delta)||void 0===i?void 0:i.content)&&void 0!==n?n:"",null===r||void 0===r||r.handleLLMNewToken(null!==(o=null===(l=e.delta)||void 0===l?void 0:l.content)&&void 0!==o?o:"",{prompt:null!==(u=t.promptIndex)&&void 0!==u?u:0,completion:e.index})}};for(m.s();!(v=m.n()).done;)f()}catch(b){m.e(b)}finally{m.f()}s||o||!d.choices.every((function(e){return null!=e.finish_reason}))||(s=!0,e(a))}}})).catch((function(e){o||(o=!0,i(e))}))}));case 4:e.t0=e.sent,e.next=10;break;case 7:return e.next=9,this.completionWithRetry((0,p.Z)((0,p.Z)({},u),{},{messages:this.formatMessages(n)}),(0,p.Z)({signal:t.signal},t.options));case 9:e.t0=e.sent;case 10:return s=e.t0,e.abrupt("return",null!==(i=null===(o=s.choices[0].message)||void 0===o?void 0:o.content)&&void 0!==i?i:"");case 12:case"end":return e.stop()}}),e,this)})));return function(n,t,r){return e.apply(this,arguments)}}()},{key:"completionWithRetry",value:function(){var e=(0,u.Z)((0,a.Z)().mark((function e(n,t){var r,i,o;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.client||(r=this.azureOpenAIApiKey?"https://".concat(this.azureOpenAIApiInstanceName,".openai.azure.com/openai/deployments/").concat(this.azureOpenAIApiDeploymentName):this.clientConfig.basePath,i=new b.Configuration((0,p.Z)((0,p.Z)({},this.clientConfig),{},{basePath:r,baseOptions:(0,p.Z)({timeout:this.timeout},this.clientConfig.baseOptions)})),this.client=new b.OpenAIApi(i)),o=(0,p.Z)((0,p.Z)({adapter:(0,y.UG)()?void 0:A.Z},this.clientConfig.baseOptions),t),this.azureOpenAIApiKey&&(o.headers=(0,p.Z)({"api-key":this.azureOpenAIApiKey},o.headers),o.params=(0,p.Z)({"api-version":this.azureOpenAIApiVersion},o.params)),e.abrupt("return",this.caller.call(this.client.createChatCompletion.bind(this.client),n,o).then((function(e){return e.data})));case 4:case"end":return e.stop()}}),e,this)})));return function(n,t){return e.apply(this,arguments)}}()},{key:"_llmType",value:function(){return"openai"}}]),t}(g.S),I=function(e){(0,m.Z)(t,e);var n=(0,f.Z)(t);function t(e){var r,i,a,o;if((0,s.Z)(this,t),o=n.call(this,e),Object.defineProperty((0,v.Z)(o),"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty((0,v.Z)(o),"promptLayerApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty((0,v.Z)(o),"plTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty((0,v.Z)(o),"returnPromptLayerId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),o.plTags=null!==(r=null===e||void 0===e?void 0:e.plTags)&&void 0!==r?r:[],o.returnPromptLayerId=null!==(i=null===e||void 0===e?void 0:e.returnPromptLayerId)&&void 0!==i&&i,o.promptLayerApiKey=null!==(a=null===e||void 0===e?void 0:e.promptLayerApiKey)&&void 0!==a?a:(0,y.lS)("PROMPTLAYER_API_KEY"),!o.promptLayerApiKey)throw new Error("Missing PromptLayer API key");return o}return(0,c.Z)(t,[{key:"lc_secrets",get:function(){return{promptLayerApiKey:"PROMPTLAYER_API_KEY"}}},{key:"completionWithRetry",value:function(){var e=(0,u.Z)((0,a.Z)().mark((function e(n,o){var l;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!n.stream){e.next=2;break}return e.abrupt("return",(0,r.Z)((0,i.Z)(t.prototype),"completionWithRetry",this).call(this,n,o));case 2:return e.next=4,(0,r.Z)((0,i.Z)(t.prototype),"completionWithRetry",this).call(this,n);case 4:return l=e.sent,e.abrupt("return",l);case 6:case"end":return e.stop()}}),e,this)})));return function(n,t){return e.apply(this,arguments)}}()},{key:"_generate",value:function(){var e=(0,u.Z)((0,a.Z)().mark((function e(n,t,r){var i,o,l=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all(n.map(function(){var e=(0,u.Z)((0,a.Z)().mark((function e(n){var o,u,p,s,c;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=Date.now(),e.next=3,l._call(n,t,r);case 3:return u=e.sent,p=Date.now(),i=[{text:u}],s={text:u},e.next=9,(0,P.r)(l.caller,"langchain.PromptLayerOpenAIChat",[n],l._identifyingParams(),l.plTags,s,o,p,l.promptLayerApiKey);case 9:return c=e.sent,!0===l.returnPromptLayerId&&!0===c.success&&(i[0].generationInfo={promptLayerRequestId:c.request_id}),e.abrupt("return",i);case 12:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}()));case 2:return o=e.sent,e.abrupt("return",{generations:o});case 4:case"end":return e.stop()}}),e)})));return function(n,t,r){return e.apply(this,arguments)}}()}]),t}(Z),_=function(e){(0,m.Z)(t,e);var n=(0,f.Z)(t);function t(e,r){var i,a,o,l,u,c,m,f,b,A,h,g,O,P,I,_,w,k,N,z;if((0,s.Z)(this,t),null!==e&&void 0!==e&&null!==(i=e.modelName)&&void 0!==i&&i.startsWith("gpt-3.5-turbo")||null!==e&&void 0!==e&&null!==(a=e.modelName)&&void 0!==a&&a.startsWith("gpt-4")||null!==e&&void 0!==e&&null!==(o=e.modelName)&&void 0!==o&&o.startsWith("gpt-4-32k"))return(0,d.Z)(z,new Z(e,r));if(z=n.call(this,null!==e&&void 0!==e?e:{}),Object.defineProperty((0,v.Z)(z),"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty((0,v.Z)(z),"temperature",{enumerable:!0,configurable:!0,writable:!0,value:.7}),Object.defineProperty((0,v.Z)(z),"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:256}),Object.defineProperty((0,v.Z)(z),"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty((0,v.Z)(z),"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty((0,v.Z)(z),"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty((0,v.Z)(z),"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty((0,v.Z)(z),"bestOf",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty((0,v.Z)(z),"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty((0,v.Z)(z),"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"text-davinci-003"}),Object.defineProperty((0,v.Z)(z),"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty((0,v.Z)(z),"batchSize",{enumerable:!0,configurable:!0,writable:!0,value:20}),Object.defineProperty((0,v.Z)(z),"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty((0,v.Z)(z),"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty((0,v.Z)(z),"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty((0,v.Z)(z),"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty((0,v.Z)(z),"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty((0,v.Z)(z),"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty((0,v.Z)(z),"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty((0,v.Z)(z),"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty((0,v.Z)(z),"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty((0,v.Z)(z),"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),z.openAIApiKey=null!==(l=null===e||void 0===e?void 0:e.openAIApiKey)&&void 0!==l?l:(0,y.lS)("OPENAI_API_KEY"),z.azureOpenAIApiKey=null!==(u=null===e||void 0===e?void 0:e.azureOpenAIApiKey)&&void 0!==u?u:(0,y.lS)("AZURE_OPENAI_API_KEY"),!z.azureOpenAIApiKey&&!z.openAIApiKey)throw new Error("(Azure) OpenAI API key not found");if(z.azureOpenAIApiInstanceName=null!==(c=null===e||void 0===e?void 0:e.azureOpenAIApiInstanceName)&&void 0!==c?c:(0,y.lS)("AZURE_OPENAI_API_INSTANCE_NAME"),z.azureOpenAIApiDeploymentName=null!==(m=(null===e||void 0===e?void 0:e.azureOpenAIApiCompletionsDeploymentName)||(null===e||void 0===e?void 0:e.azureOpenAIApiDeploymentName))&&void 0!==m?m:(0,y.lS)("AZURE_OPENAI_API_COMPLETIONS_DEPLOYMENT_NAME")||(0,y.lS)("AZURE_OPENAI_API_DEPLOYMENT_NAME"),z.azureOpenAIApiVersion=null!==(f=null===e||void 0===e?void 0:e.azureOpenAIApiVersion)&&void 0!==f?f:(0,y.lS)("AZURE_OPENAI_API_VERSION"),z.modelName=null!==(b=null===e||void 0===e?void 0:e.modelName)&&void 0!==b?b:z.modelName,z.modelKwargs=null!==(A=null===e||void 0===e?void 0:e.modelKwargs)&&void 0!==A?A:{},z.batchSize=null!==(h=null===e||void 0===e?void 0:e.batchSize)&&void 0!==h?h:z.batchSize,z.timeout=null===e||void 0===e?void 0:e.timeout,z.temperature=null!==(g=null===e||void 0===e?void 0:e.temperature)&&void 0!==g?g:z.temperature,z.maxTokens=null!==(O=null===e||void 0===e?void 0:e.maxTokens)&&void 0!==O?O:z.maxTokens,z.topP=null!==(P=null===e||void 0===e?void 0:e.topP)&&void 0!==P?P:z.topP,z.frequencyPenalty=null!==(I=null===e||void 0===e?void 0:e.frequencyPenalty)&&void 0!==I?I:z.frequencyPenalty,z.presencePenalty=null!==(_=null===e||void 0===e?void 0:e.presencePenalty)&&void 0!==_?_:z.presencePenalty,z.n=null!==(w=null===e||void 0===e?void 0:e.n)&&void 0!==w?w:z.n,z.bestOf=null!==(k=null===e||void 0===e?void 0:e.bestOf)&&void 0!==k?k:z.bestOf,z.logitBias=null===e||void 0===e?void 0:e.logitBias,z.stop=null===e||void 0===e?void 0:e.stop,z.streaming=null!==(N=null===e||void 0===e?void 0:e.streaming)&&void 0!==N&&N,z.streaming&&z.bestOf&&z.bestOf>1)throw new Error("Cannot stream results when bestOf > 1");if(z.azureOpenAIApiKey){if(!z.azureOpenAIApiInstanceName)throw new Error("Azure OpenAI API instance name not found");if(!z.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!z.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found")}return z.clientConfig=(0,p.Z)((0,p.Z)({apiKey:z.openAIApiKey},r),null===e||void 0===e?void 0:e.configuration),z}return(0,c.Z)(t,[{key:"callKeys",get:function(){return["stop","signal","timeout","options"]}},{key:"lc_secrets",get:function(){return{openAIApiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY"}}},{key:"lc_aliases",get:function(){return{modelName:"model",openAIApiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}},{key:"invocationParams",value:function(e){var n;return(0,p.Z)({model:this.modelName,temperature:this.temperature,max_tokens:this.maxTokens,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,n:this.n,best_of:this.bestOf,logit_bias:this.logitBias,stop:null!==(n=null===e||void 0===e?void 0:e.stop)&&void 0!==n?n:this.stop,stream:this.streaming},this.modelKwargs)}},{key:"_identifyingParams",value:function(){return(0,p.Z)((0,p.Z)({model_name:this.modelName},this.invocationParams()),this.clientConfig)}},{key:"identifyingParams",value:function(){return this._identifyingParams()}},{key:"_generate",value:function(){var e=(0,u.Z)((0,a.Z)().mark((function e(n,t,r){var i,u,s,c,d,v,m,f=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=h(n,this.batchSize),u=[],s={},-1!==(c=this.invocationParams(t)).max_tokens){e.next=10;break}if(1===n.length){e.next=7;break}throw new Error("max_tokens set to -1 not supported for multiple inputs");case 7:return e.next=9,(0,O.F1)({prompt:n[0],modelName:this.modelName});case 9:c.max_tokens=e.sent;case 10:d=(0,a.Z)().mark((function e(n){var d,v,m,b,y,h,g,O,P;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!c.stream){e.next=6;break}return e.next=3,new Promise((function(e,a){var o,u=[],s=!1,d=!1;f.completionWithRetry((0,p.Z)((0,p.Z)({},c),{},{prompt:i[n]}),(0,p.Z)((0,p.Z)({signal:t.signal},t.options),{},{adapter:A.Z,responseType:"stream",onmessage:function(n){var t,i;if("[DONE]"===(null===(t=n.data)||void 0===t||null===(i=t.trim)||void 0===i?void 0:i.call(t))){if(d||s)return;d=!0,e((0,p.Z)((0,p.Z)({},o),{},{choices:u}))}else{var c=JSON.parse(n.data);if(null!==c&&void 0!==c&&c.error){if(s)return;return s=!0,void a(c.error)}var v=c;o||(o={id:v.id,object:v.object,created:v.created,model:v.model});var m,b=(0,l.Z)(v.choices);try{for(b.s();!(m=b.n()).done;){var y=m.value;if(null!=y&&null!=y.index){var A,h,g;u[y.index]||(u[y.index]={});var O=u[y.index];O.text=(null!==(A=O.text)&&void 0!==A?A:"")+(null!==(h=y.text)&&void 0!==h?h:""),O.finish_reason=y.finish_reason,O.logprobs=y.logprobs,null===r||void 0===r||r.handleLLMNewToken(null!==(g=y.text)&&void 0!==g?g:"",{prompt:Math.floor(y.index/f.n),completion:y.index%f.n})}}}catch(P){b.e(P)}finally{b.f()}d||s||!u.every((function(e){return null!=e.finish_reason}))||(d=!0,e((0,p.Z)((0,p.Z)({},o),{},{choices:u})))}}})).catch((function(e){s||(s=!0,a(e))}))}));case 3:e.t0=e.sent,e.next=9;break;case 6:return e.next=8,f.completionWithRetry((0,p.Z)((0,p.Z)({},c),{},{prompt:i[n]}),(0,p.Z)({signal:t.signal},t.options));case 8:e.t0=e.sent;case 9:v=e.t0,u.push.apply(u,(0,o.Z)(v.choices)),m=null!==(d=v.usage)&&void 0!==d?d:{},b=m.completion_tokens,y=m.prompt_tokens,h=m.total_tokens,b&&(s.completionTokens=(null!==(g=s.completionTokens)&&void 0!==g?g:0)+b),y&&(s.promptTokens=(null!==(O=s.promptTokens)&&void 0!==O?O:0)+y),h&&(s.totalTokens=(null!==(P=s.totalTokens)&&void 0!==P?P:0)+h);case 15:case"end":return e.stop()}}),e)})),v=0;case 12:if(!(v<i.length)){e.next=17;break}return e.delegateYield(d(v),"t0",14);case 14:v+=1,e.next=12;break;case 17:return m=h(u,this.n).map((function(e){return e.map((function(e){var n;return{text:null!==(n=e.text)&&void 0!==n?n:"",generationInfo:{finishReason:e.finish_reason,logprobs:e.logprobs}}}))})),e.abrupt("return",{generations:m,llmOutput:{tokenUsage:s}});case 19:case"end":return e.stop()}}),e,this)})));return function(n,t,r){return e.apply(this,arguments)}}()},{key:"completionWithRetry",value:function(){var e=(0,u.Z)((0,a.Z)().mark((function e(n,t){var r,i,o;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.client||(r=this.azureOpenAIApiKey?"https://".concat(this.azureOpenAIApiInstanceName,".openai.azure.com/openai/deployments/").concat(this.azureOpenAIApiDeploymentName):this.clientConfig.basePath,i=new b.Configuration((0,p.Z)((0,p.Z)({},this.clientConfig),{},{basePath:r,baseOptions:(0,p.Z)({timeout:this.timeout},this.clientConfig.baseOptions)})),this.client=new b.OpenAIApi(i)),o=(0,p.Z)((0,p.Z)({adapter:(0,y.UG)()?void 0:A.Z},this.clientConfig.baseOptions),t),this.azureOpenAIApiKey&&(o.headers=(0,p.Z)({"api-key":this.azureOpenAIApiKey},o.headers),o.params=(0,p.Z)({"api-version":this.azureOpenAIApiVersion},o.params)),e.abrupt("return",this.caller.call(this.client.createCompletion.bind(this.client),n,o).then((function(e){return e.data})));case 4:case"end":return e.stop()}}),e,this)})));return function(n,t){return e.apply(this,arguments)}}()},{key:"_llmType",value:function(){return"openai"}}]),t}(g.x),w=function(e){(0,m.Z)(t,e);var n=(0,f.Z)(t);function t(e){var r,i,a;if((0,s.Z)(this,t),a=n.call(this,e),Object.defineProperty((0,v.Z)(a),"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty((0,v.Z)(a),"promptLayerApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty((0,v.Z)(a),"plTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty((0,v.Z)(a),"returnPromptLayerId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),a.plTags=null!==(r=null===e||void 0===e?void 0:e.plTags)&&void 0!==r?r:[],a.promptLayerApiKey=null!==(i=null===e||void 0===e?void 0:e.promptLayerApiKey)&&void 0!==i?i:(0,y.lS)("PROMPTLAYER_API_KEY"),a.returnPromptLayerId=null===e||void 0===e?void 0:e.returnPromptLayerId,!a.promptLayerApiKey)throw new Error("Missing PromptLayer API key");return a}return(0,c.Z)(t,[{key:"lc_secrets",get:function(){return{promptLayerApiKey:"PROMPTLAYER_API_KEY"}}},{key:"completionWithRetry",value:function(){var e=(0,u.Z)((0,a.Z)().mark((function e(n,o){var l;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!n.stream){e.next=2;break}return e.abrupt("return",(0,r.Z)((0,i.Z)(t.prototype),"completionWithRetry",this).call(this,n,o));case 2:return e.next=4,(0,r.Z)((0,i.Z)(t.prototype),"completionWithRetry",this).call(this,n);case 4:return l=e.sent,e.abrupt("return",l);case 6:case"end":return e.stop()}}),e,this)})));return function(n,t){return e.apply(this,arguments)}}()},{key:"_generate",value:function(){var e=(0,u.Z)((0,a.Z)().mark((function e(n,o,l){var u,s,c,d,v,m,f;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return u=Date.now(),e.next=3,(0,r.Z)((0,i.Z)(t.prototype),"_generate",this).call(this,n,o,l);case 3:s=e.sent,c=0;case 5:if(!(c<s.generations.length)){e.next=16;break}return d=Date.now(),v={text:s.generations[c][0].text,llm_output:s.llmOutput},e.next=10,(0,P.r)(this.caller,"langchain.PromptLayerOpenAI",[n[c]],this._identifyingParams(),this.plTags,v,u,d,this.promptLayerApiKey);case 10:m=e.sent,f=void 0,!0===this.returnPromptLayerId&&(m&&!0===m.success&&(f=m.request_id),s.generations[c][0].generationInfo=(0,p.Z)((0,p.Z)({},s.generations[c][0].generationInfo),{},{promptLayerRequestId:f}));case 13:c+=1,e.next=5;break;case 16:return e.abrupt("return",s);case 17:case"end":return e.stop()}}),e,this)})));return function(n,t,r){return e.apply(this,arguments)}}()}]),t}(_)}}]);
//# sourceMappingURL=525.fa84221f.chunk.js.map